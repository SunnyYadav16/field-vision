<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>FieldVision - Safety Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .order-details {
            display: none;
        }

        .order-card.expanded .order-details {
            display: block;
        }

        .order-card {
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-card:hover {
            transform: translateX(4px);
        }
    </style>
</head>

<body class="bg-gray-900 text-white">

    <!-- Header Bar -->
    <div class="bg-gray-800 border-b border-gray-700 px-4 py-2 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <span class="text-amber-400 font-bold text-lg">‚öôÔ∏è FieldVision</span>
            <span class="text-gray-400">|</span>
            <span class="text-gray-400 text-sm">Safety Manager Dashboard</span>
        </div>
        <div class="flex items-center gap-4">
            <span id="userName" class="text-gray-300 text-sm"></span>
            <span id="userRole" class="text-xs bg-amber-900 text-amber-300 px-2 py-0.5 rounded"></span>
            <button onclick="logout()" class="text-gray-400 text-sm hover:text-red-400">Logout</button>
        </div>
    </div>

    <div class="flex h-[calc(100vh-48px)]">

        <!-- Left: Camera Grid (2x2) - Dynamic Feeds -->
        <div class="w-1/2 p-4">
            <div class="grid grid-cols-2 gap-3 h-full" id="cameraGrid">
                <!-- Camera slots will be populated dynamically -->
                <div
                    class="cam-slot bg-gray-800 rounded-lg overflow-hidden border border-gray-700 relative flex items-center justify-center text-gray-500">
                    <span>CAM 1 - Waiting...</span>
                </div>
                <div
                    class="cam-slot bg-gray-800 rounded-lg overflow-hidden border border-gray-700 relative flex items-center justify-center text-gray-500">
                    <span>CAM 2 - Waiting...</span>
                </div>
                <div
                    class="cam-slot bg-gray-800 rounded-lg overflow-hidden border border-gray-700 relative flex items-center justify-center text-gray-500">
                    <span>CAM 3 - Waiting...</span>
                </div>
                <div
                    class="cam-slot bg-gray-800 rounded-lg overflow-hidden border border-gray-700 relative flex items-center justify-center text-gray-500">
                    <span>CAM 4 - Waiting...</span>
                </div>
            </div>
        </div>

        <!-- Right: Work Orders Dashboard -->
        <div class="w-1/2 bg-gray-800 border-l border-gray-700 p-4 flex flex-col overflow-hidden">

            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-amber-400">üìã Work Orders Dashboard</h1>
                <button onclick="loadAllOrders()" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">
                    üîÑ Refresh</button>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-yellow-900/50 border border-yellow-700 rounded-lg p-3 text-center">
                    <div id="pendingCount" class="text-2xl font-bold text-yellow-300">0</div>
                    <div class="text-xs text-yellow-400">Pending</div>
                </div>
                <div class="bg-blue-900/50 border border-blue-700 rounded-lg p-3 text-center">
                    <div id="approvedCount" class="text-2xl font-bold text-blue-300">0</div>
                    <div class="text-xs text-blue-400">In Progress</div>
                </div>
                <div class="bg-green-900/50 border border-green-700 rounded-lg p-3 text-center">
                    <div id="completedCount" class="text-2xl font-bold text-green-300">0</div>
                    <div class="text-xs text-green-400">Completed</div>
                </div>
            </div>

            <!-- Orders Sections -->
            <div class="flex-1 overflow-y-auto space-y-4">

                <!-- Pending Orders -->
                <div class="bg-gray-900 rounded-lg p-3">
                    <h2 class="text-yellow-400 font-bold mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                        Pending Approval
                    </h2>
                    <div id="pendingOrders" class="space-y-2">
                        <p class="text-gray-500 text-sm">No pending orders</p>
                    </div>
                </div>

                <!-- Approved Orders -->
                <div class="bg-gray-900 rounded-lg p-3">
                    <h2 class="text-blue-400 font-bold mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-400 rounded-full"></span>
                        Approved / In Progress
                    </h2>
                    <div id="approvedOrders" class="space-y-2">
                        <p class="text-gray-500 text-sm">No approved orders</p>
                    </div>
                </div>

                <!-- Completed Orders -->
                <div class="bg-gray-900 rounded-lg p-3">
                    <h2 class="text-green-400 font-bold mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                        Completed
                    </h2>
                    <div id="completedOrders" class="space-y-2">
                        <p class="text-gray-500 text-sm">No completed orders</p>
                    </div>
                </div>
            </div>

            <!-- Generate Report Button -->
            <button onclick="openReportModal()" class="mt-4 w-full bg-amber-500 hover:bg-amber-600
                text-gray-900 font-bold py-2 rounded transition-colors">
                üìä Generate Compliance Report
            </button>
        </div>
    </div>

    <!-- Report Timeline Modal -->
    <div id="reportModal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-50">
        <div class="bg-gray-800 rounded-lg p-6 w-[420px] border border-gray-600 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-amber-400">üìä Generate Report</h2>
                <button onclick="closeReportModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
            </div>

            <p class="text-gray-300 text-sm mb-4">Select a time range for the compliance report:</p>

            <!-- Preset Buttons -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <button onclick="setPreset('24h')"
                    class="preset-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm">
                    Last 24 Hours</button>
                <button onclick="setPreset('7d')" class="preset-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm">
                    Last 7 Days</button>
                <button onclick="setPreset('30d')"
                    class="preset-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm">
                    Last 30 Days</button>
                <button onclick="setPreset('3m')" class="preset-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm">
                    Last 3 Months</button>
                <button onclick="setPreset('6m')" class="preset-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm">
                    Last 6 Months</button>
                <button onclick="setPreset('custom')"
                    class="preset-btn bg-gray-700 hover:bg-gray-600 py-2 rounded text-sm">
                    Custom Range</button>
            </div>

            <!-- Custom Date Picker (hidden by default) -->
            <div id="customDatePicker" class="hidden mb-4 p-3 bg-gray-900 rounded">
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-xs text-gray-400">Start Date</label>
                        <input type="date" id="startDate"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                    </div>
                    <div>
                        <label class="text-xs text-gray-400">End Date</label>
                        <input type="date" id="endDate"
                            class="w-full bg-gray-700 border border-gray-600 rounded px-2 py-1 text-sm">
                    </div>
                </div>
            </div>

            <!-- Selected Range Display -->
            <div id="selectedRange" class="text-center text-sm text-gray-400 mb-4">
                Select a time range above
            </div>

            <!-- Generate Button -->
            <button id="generateBtn" onclick="downloadReport()" disabled class="w-full bg-amber-500 hover:bg-amber-600 disabled:bg-gray-600 disabled:cursor-not-allowed
                text-gray-900 font-bold py-2 rounded transition-colors">
                üìÑ Download PDF Report
            </button>
        </div>
    </div>

    <script>
        // Auth check
        const token = localStorage.getItem('fv_token');
        const user = JSON.parse(localStorage.getItem('fv_user') || 'null');
        if (!token || !user) window.location.href = '/login';
        if (user?.role === 'technician') window.location.href = '/';

        document.getElementById('userName').textContent = user?.name || '';
        document.getElementById('userRole').textContent = user?.role?.replace('_', ' ') || '';

        function logout() {
            localStorage.removeItem('fv_token');
            localStorage.removeItem('fv_user');
            window.location.href = '/login';
        }

        // ‚îÄ‚îÄ Report Modal Logic ‚îÄ‚îÄ
        let reportStartDate = null;
        let reportEndDate = null;

        function openReportModal() {
            document.getElementById('reportModal').classList.remove('hidden');
            document.getElementById('reportModal').classList.add('flex');
            resetReportModal();
        }

        function closeReportModal() {
            document.getElementById('reportModal').classList.add('hidden');
            document.getElementById('reportModal').classList.remove('flex');
        }

        function resetReportModal() {
            reportStartDate = null;
            reportEndDate = null;
            document.getElementById('selectedRange').textContent = 'Select a time range above';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('customDatePicker').classList.add('hidden');
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('bg-amber-600');
                btn.classList.add('bg-gray-700');
            });
        }

        function setPreset(preset) {
            const now = new Date();
            reportEndDate = new Date(now);

            // Reset button styles
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('bg-amber-600');
                btn.classList.add('bg-gray-700');
            });

            if (preset === 'custom') {
                document.getElementById('customDatePicker').classList.remove('hidden');
                document.getElementById('selectedRange').textContent = 'Select custom dates below';

                // Set up date input listeners
                document.getElementById('startDate').onchange = updateCustomDates;
                document.getElementById('endDate').onchange = updateCustomDates;
                return;
            }

            document.getElementById('customDatePicker').classList.add('hidden');

            switch (preset) {
                case '24h':
                    reportStartDate = new Date(now - 24 * 60 * 60 * 1000);
                    break;
                case '7d':
                    reportStartDate = new Date(now - 7 * 24 * 60 * 60 * 1000);
                    break;
                case '30d':
                    reportStartDate = new Date(now - 30 * 24 * 60 * 60 * 1000);
                    break;
                case '3m':
                    reportStartDate = new Date(now);
                    reportStartDate.setMonth(reportStartDate.getMonth() - 3);
                    break;
                case '6m':
                    reportStartDate = new Date(now);
                    reportStartDate.setMonth(reportStartDate.getMonth() - 6);
                    break;
            }

            // Highlight selected button
            event.target.classList.remove('bg-gray-700');
            event.target.classList.add('bg-amber-600');

            updateRangeDisplay();
        }

        function updateCustomDates() {
            const startInput = document.getElementById('startDate').value;
            const endInput = document.getElementById('endDate').value;

            if (startInput && endInput) {
                reportStartDate = new Date(startInput);
                reportEndDate = new Date(endInput);
                reportEndDate.setHours(23, 59, 59); // End of day
                updateRangeDisplay();
            }
        }

        function updateRangeDisplay() {
            if (reportStartDate && reportEndDate) {
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                document.getElementById('selectedRange').textContent =
                    `${reportStartDate.toLocaleDateString('en-US', options)} ‚Üí ${reportEndDate.toLocaleDateString('en-US', options)}`;
                document.getElementById('generateBtn').disabled = false;
            }
        }

        async function downloadReport() {
            if (!reportStartDate || !reportEndDate) return;

            const btn = document.getElementById('generateBtn');
            btn.textContent = '‚è≥ Generating...';
            btn.disabled = true;

            try {
                const start = reportStartDate.toISOString();
                const end = reportEndDate.toISOString();

                const res = await fetch(
                    `/api/reports/work-orders?start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`,
                    { headers: { 'Authorization': `Bearer ${token}` } }
                );

                if (!res.ok) throw new Error('Failed to generate report');

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `work_orders_report.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                closeReportModal();
            } catch (err) {
                console.error('Report generation failed:', err);
                alert('Failed to generate report. Please try again.');
            } finally {
                btn.textContent = 'üìÑ Download PDF Report';
                btn.disabled = false;
            }
        }

        // Close modal when clicking backdrop
        document.getElementById('reportModal').addEventListener('click', (e) => {
            if (e.target.id === 'reportModal') closeReportModal();
        });

        // Track expanded orders to persist across refreshes
        const expandedOrders = new Set();

        // Toggle order details
        function toggleOrderDetails(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) {
                card.classList.toggle('expanded');
                if (card.classList.contains('expanded')) {
                    expandedOrders.add(orderId);
                } else {
                    expandedOrders.delete(orderId);
                }
            }
        }

        // Priority badge classes
        function getPriorityClass(priority) {
            switch (priority) {
                case 'critical': return 'bg-red-600 text-white';
                case 'high': return 'bg-red-900 text-red-300';
                case 'medium': return 'bg-yellow-900 text-yellow-300';
                case 'low': return 'bg-gray-700 text-gray-300';
                default: return 'bg-gray-700 text-gray-300';
            }
        }

        // Format date
        function formatDate(isoDate) {
            if (!isoDate) return 'N/A';
            return new Date(isoDate).toLocaleString();
        }

        // Render order card
        function renderOrderCard(order, type) {
            const priorityClass = getPriorityClass(order.priority);

            let actionButtons = '';
            if (type === 'pending') {
                actionButtons = `
                    <button onclick="event.stopPropagation(); approveOrder('${order.order_id}')"
                        class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                        ‚úì Approve</button>`;
            } else if (type === 'approved') {
                actionButtons = `
                    <button onclick="event.stopPropagation(); completeOrder('${order.order_id}')"
                        class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        ‚úì Complete</button>`;
            }

            return `
                <div id="order-${order.order_id}" class="order-card bg-gray-700 rounded p-3 text-sm border-l-4 
                    ${type === 'pending' ? 'border-yellow-500' : type === 'approved' ? 'border-blue-500' : 'border-green-500'}"
                    onclick="toggleOrderDetails('${order.order_id}')">
                    
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white">${order.order_id}</span>
                            <span class="text-xs px-2 py-0.5 rounded ${priorityClass}">
                                ${order.priority.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${actionButtons}
                            <span class="text-gray-500 text-xs">‚ñº</span>
                        </div>
                    </div>
                    
                    <p class="text-gray-300 mt-1 font-medium">${order.equipment}</p>
                    <p class="text-gray-400 text-xs">${order.description}</p>
                    
                    <!-- Expandable Details -->
                    <div class="order-details mt-3 pt-3 border-t border-gray-600 space-y-2">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-500">Requested By:</span>
                                <span class="text-gray-300 ml-1">${order.requested_by?.name || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Role:</span>
                                <span class="text-gray-300 ml-1">${order.requested_by?.role || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Created:</span>
                                <span class="text-gray-300 ml-1">${formatDate(order.created_at)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Badge Verified:</span>
                                <span class="${order.badge_verified ? 'text-green-400' : 'text-red-400'} ml-1">
                                    ${order.badge_verified ? '‚úì Yes' : '‚úó No'}</span>
                            </div>
                            ${order.approved_at ? `
                            <div>
                                <span class="text-gray-500">Approved:</span>
                                <span class="text-gray-300 ml-1">${formatDate(order.approved_at)}</span>
                            </div>` : ''}
                            ${order.completed_at ? `
                            <div>
                                <span class="text-gray-500">Completed:</span>
                                <span class="text-gray-300 ml-1">${formatDate(order.completed_at)}</span>
                            </div>` : ''}
                            ${order.escalated_to ? `
                            <div class="col-span-2">
                                <span class="text-gray-500">Escalated To:</span>
                                <span class="text-amber-300 ml-1">${order.escalated_to}</span>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Load all orders
        async function loadAllOrders() {
            try {
                const res = await fetch('/api/work-orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const pending = data.pending || [];
                const approved = data.approved || [];
                const completed = data.completed || [];

                // Update counts
                document.getElementById('pendingCount').textContent = pending.length;
                document.getElementById('approvedCount').textContent = approved.length;
                document.getElementById('completedCount').textContent = completed.length;

                // Render pending
                document.getElementById('pendingOrders').innerHTML = pending.length > 0
                    ? pending.map(o => renderOrderCard(o, 'pending')).join('')
                    : '<p class="text-gray-500 text-sm">No pending orders</p>';

                // Render approved
                document.getElementById('approvedOrders').innerHTML = approved.length > 0
                    ? approved.map(o => renderOrderCard(o, 'approved')).join('')
                    : '<p class="text-gray-500 text-sm">No orders in progress</p>';

                // Render completed
                document.getElementById('completedOrders').innerHTML = completed.length > 0
                    ? completed.map(o => renderOrderCard(o, 'completed')).join('')
                    : '<p class="text-gray-500 text-sm">No completed orders</p>';

                // Restore expanded states after re-render
                expandedOrders.forEach(orderId => {
                    const card = document.getElementById(`order-${orderId}`);
                    if (card) card.classList.add('expanded');
                });

            } catch (err) {
                console.error('Failed to load work orders:', err);
            }
        }

        // Approve order
        async function approveOrder(orderId) {
            const res = await fetch(`/api/work-orders/${orderId}/approve`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) loadAllOrders();
        }

        // Complete order
        async function completeOrder(orderId) {
            const res = await fetch(`/api/work-orders/${orderId}/complete`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) loadAllOrders();
        }

        // Close expanded order when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.order-card')) {
                // Clicked outside any order card - close all
                expandedOrders.clear();
                document.querySelectorAll('.order-card.expanded').forEach(card => {
                    card.classList.remove('expanded');
                });
            }
        });

        // Poll every 5 seconds
        setInterval(loadAllOrders, 5000);
        loadAllOrders();

        // ‚îÄ‚îÄ Camera Feed Polling ‚îÄ‚îÄ
        const cameraSlots = document.querySelectorAll('.cam-slot');
        let activeFeedUsers = [];

        async function loadCameraFeeds() {
            try {
                const res = await fetch('/api/camera-feeds', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (!res.ok) return;

                const data = await res.json();
                activeFeedUsers = data.feeds || [];

                // Update camera slots
                cameraSlots.forEach((slot, index) => {
                    if (index < activeFeedUsers.length) {
                        const feed = activeFeedUsers[index];
                        updateCameraSlot(slot, feed, index + 1);
                    } else {
                        // No feed for this slot
                        slot.innerHTML = `<span class="text-gray-500">CAM ${index + 1} - Offline</span>`;
                    }
                });
            } catch (err) {
                console.error('Failed to load camera feeds:', err);
            }
        }

        function updateCameraSlot(slot, feed, camNum) {
            const userId = feed.user_id;
            const imgId = `cam-img-${userId}`;

            // Check if image already exists
            let img = document.getElementById(imgId);
            if (!img) {
                // Create new image element with overlay
                slot.innerHTML = `
                    <img id="${imgId}" class="w-full h-full object-cover" alt="Camera feed">
                    <div class="absolute top-2 left-2 bg-green-600/80 text-xs px-2 py-1 rounded flex items-center gap-1">
                        <span class="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                        CAM ${camNum} - ${feed.zone} - LIVE
                    </div>
                    <div class="absolute bottom-2 left-2 bg-black/60 text-xs px-2 py-1 rounded">
                        ${feed.name}
                    </div>
                `;
                img = document.getElementById(imgId);
            }

            // Fetch frame with auth header and set as blob URL
            fetch(`/api/camera-feeds/${userId}/frame`, {
                headers: { 'Authorization': `Bearer ${token}` }
            })
                .then(res => res.ok ? res.blob() : null)
                .then(blob => {
                    if (blob && img) {
                        const oldSrc = img.src;
                        img.src = URL.createObjectURL(blob);
                        // Revoke old blob URL to prevent memory leak
                        if (oldSrc.startsWith('blob:')) URL.revokeObjectURL(oldSrc);
                    }
                })
                .catch(() => { });
        }

        // Poll camera feeds every 1 second for smoother updates
        setInterval(loadCameraFeeds, 1000);
        loadCameraFeeds();
    </script>
</body>

</html>