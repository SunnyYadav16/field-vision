<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>FieldVision - Safety Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .order-details {
            display: none;
        }

        .order-card.expanded .order-details {
            display: block;
        }

        .order-card {
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-card:hover {
            transform: translateX(4px);
        }
    </style>
</head>

<body class="bg-gray-900 text-white">

    <!-- Header Bar -->
    <div class="bg-gray-800 border-b border-gray-700 px-4 py-2 flex justify-between items-center">
        <div class="flex items-center gap-3">
            <span class="text-amber-400 font-bold text-lg">‚öôÔ∏è FieldVision</span>
            <span class="text-gray-400">|</span>
            <span class="text-gray-400 text-sm">Safety Manager Dashboard</span>
        </div>
        <div class="flex items-center gap-4">
            <span id="userName" class="text-gray-300 text-sm"></span>
            <span id="userRole" class="text-xs bg-amber-900 text-amber-300 px-2 py-0.5 rounded"></span>
            <button onclick="logout()" class="text-gray-400 text-sm hover:text-red-400">Logout</button>
        </div>
    </div>

    <div class="flex h-[calc(100vh-48px)]">

        <!-- Left: Camera Grid (2x2) -->
        <div class="w-1/2 p-4">
            <div class="grid grid-cols-2 gap-3 h-full">
                <!-- Camera 1: Live Feed -->
                <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700 relative">
                    <video id="liveCamera" autoplay muted class="w-full h-full object-cover"></video>
                    <div class="absolute top-2 left-2 bg-green-600/80 text-xs px-2 py-1 rounded">
                        CAM 1 - Floor A - LIVE</div>
                </div>
                <!-- Camera 2-4: Placeholders -->
                <div
                    class="bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center text-gray-500">
                    CAM 2 - Floor A - Offline</div>
                <div
                    class="bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center text-gray-500">
                    CAM 3 - Floor B - Offline</div>
                <div
                    class="bg-gray-800 rounded-lg border border-gray-700 flex items-center justify-center text-gray-500">
                    CAM 4 - Exterior - Offline</div>
            </div>
        </div>

        <!-- Right: Work Orders Dashboard -->
        <div class="w-1/2 bg-gray-800 border-l border-gray-700 p-4 flex flex-col overflow-hidden">

            <div class="flex justify-between items-center mb-4">
                <h1 class="text-xl font-bold text-amber-400">üìã Work Orders Dashboard</h1>
                <button onclick="loadAllOrders()" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">
                    üîÑ Refresh</button>
            </div>

            <!-- Stats Row -->
            <div class="grid grid-cols-3 gap-3 mb-4">
                <div class="bg-yellow-900/50 border border-yellow-700 rounded-lg p-3 text-center">
                    <div id="pendingCount" class="text-2xl font-bold text-yellow-300">0</div>
                    <div class="text-xs text-yellow-400">Pending</div>
                </div>
                <div class="bg-blue-900/50 border border-blue-700 rounded-lg p-3 text-center">
                    <div id="approvedCount" class="text-2xl font-bold text-blue-300">0</div>
                    <div class="text-xs text-blue-400">In Progress</div>
                </div>
                <div class="bg-green-900/50 border border-green-700 rounded-lg p-3 text-center">
                    <div id="completedCount" class="text-2xl font-bold text-green-300">0</div>
                    <div class="text-xs text-green-400">Completed</div>
                </div>
            </div>

            <!-- Orders Sections -->
            <div class="flex-1 overflow-y-auto space-y-4">

                <!-- Pending Orders -->
                <div class="bg-gray-900 rounded-lg p-3">
                    <h2 class="text-yellow-400 font-bold mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-yellow-400 rounded-full animate-pulse"></span>
                        Pending Approval
                    </h2>
                    <div id="pendingOrders" class="space-y-2">
                        <p class="text-gray-500 text-sm">No pending orders</p>
                    </div>
                </div>

                <!-- Approved Orders -->
                <div class="bg-gray-900 rounded-lg p-3">
                    <h2 class="text-blue-400 font-bold mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-blue-400 rounded-full"></span>
                        Approved / In Progress
                    </h2>
                    <div id="approvedOrders" class="space-y-2">
                        <p class="text-gray-500 text-sm">No approved orders</p>
                    </div>
                </div>

                <!-- Completed Orders -->
                <div class="bg-gray-900 rounded-lg p-3">
                    <h2 class="text-green-400 font-bold mb-2 flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-400 rounded-full"></span>
                        Completed
                    </h2>
                    <div id="completedOrders" class="space-y-2">
                        <p class="text-gray-500 text-sm">No completed orders</p>
                    </div>
                </div>
            </div>

            <!-- Generate Report Button -->
            <button onclick="generateReport()" class="mt-4 w-full bg-amber-500 hover:bg-amber-600
                text-gray-900 font-bold py-2 rounded transition-colors">
                Generate Compliance Report
            </button>
        </div>
    </div>

    <script>
        // Auth check
        const token = localStorage.getItem('fv_token');
        const user = JSON.parse(localStorage.getItem('fv_user') || 'null');
        if (!token || !user) window.location.href = '/login';
        if (user?.role === 'technician') window.location.href = '/';

        document.getElementById('userName').textContent = user?.name || '';
        document.getElementById('userRole').textContent = user?.role?.replace('_', ' ') || '';

        function logout() {
            localStorage.removeItem('fv_token');
            localStorage.removeItem('fv_user');
            window.location.href = '/login';
        }

        function generateReport() {
            alert('Report generation - Coming soon');
        }

        // Toggle order details
        function toggleOrderDetails(orderId) {
            const card = document.getElementById(`order-${orderId}`);
            if (card) card.classList.toggle('expanded');
        }

        // Priority badge classes
        function getPriorityClass(priority) {
            switch (priority) {
                case 'critical': return 'bg-red-600 text-white';
                case 'high': return 'bg-red-900 text-red-300';
                case 'medium': return 'bg-yellow-900 text-yellow-300';
                case 'low': return 'bg-gray-700 text-gray-300';
                default: return 'bg-gray-700 text-gray-300';
            }
        }

        // Format date
        function formatDate(isoDate) {
            if (!isoDate) return 'N/A';
            return new Date(isoDate).toLocaleString();
        }

        // Render order card
        function renderOrderCard(order, type) {
            const priorityClass = getPriorityClass(order.priority);

            let actionButtons = '';
            if (type === 'pending') {
                actionButtons = `
                    <button onclick="event.stopPropagation(); approveOrder('${order.order_id}')"
                        class="text-xs bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded">
                        ‚úì Approve</button>`;
            } else if (type === 'approved') {
                actionButtons = `
                    <button onclick="event.stopPropagation(); completeOrder('${order.order_id}')"
                        class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">
                        ‚úì Complete</button>`;
            }

            return `
                <div id="order-${order.order_id}" class="order-card bg-gray-700 rounded p-3 text-sm border-l-4 
                    ${type === 'pending' ? 'border-yellow-500' : type === 'approved' ? 'border-blue-500' : 'border-green-500'}"
                    onclick="toggleOrderDetails('${order.order_id}')">
                    
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white">${order.order_id}</span>
                            <span class="text-xs px-2 py-0.5 rounded ${priorityClass}">
                                ${order.priority.toUpperCase()}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            ${actionButtons}
                            <span class="text-gray-500 text-xs">‚ñº</span>
                        </div>
                    </div>
                    
                    <p class="text-gray-300 mt-1 font-medium">${order.equipment}</p>
                    <p class="text-gray-400 text-xs">${order.description}</p>
                    
                    <!-- Expandable Details -->
                    <div class="order-details mt-3 pt-3 border-t border-gray-600 space-y-2">
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <div>
                                <span class="text-gray-500">Requested By:</span>
                                <span class="text-gray-300 ml-1">${order.requested_by?.name || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Role:</span>
                                <span class="text-gray-300 ml-1">${order.requested_by?.role || 'Unknown'}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Created:</span>
                                <span class="text-gray-300 ml-1">${formatDate(order.created_at)}</span>
                            </div>
                            <div>
                                <span class="text-gray-500">Badge Verified:</span>
                                <span class="${order.badge_verified ? 'text-green-400' : 'text-red-400'} ml-1">
                                    ${order.badge_verified ? '‚úì Yes' : '‚úó No'}</span>
                            </div>
                            ${order.approved_at ? `
                            <div>
                                <span class="text-gray-500">Approved:</span>
                                <span class="text-gray-300 ml-1">${formatDate(order.approved_at)}</span>
                            </div>` : ''}
                            ${order.completed_at ? `
                            <div>
                                <span class="text-gray-500">Completed:</span>
                                <span class="text-gray-300 ml-1">${formatDate(order.completed_at)}</span>
                            </div>` : ''}
                            ${order.escalated_to ? `
                            <div class="col-span-2">
                                <span class="text-gray-500">Escalated To:</span>
                                <span class="text-amber-300 ml-1">${order.escalated_to}</span>
                            </div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // Load all orders
        async function loadAllOrders() {
            try {
                const res = await fetch('/api/work-orders', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();

                const pending = data.pending || [];
                const approved = data.approved || [];
                const completed = data.completed || [];

                // Update counts
                document.getElementById('pendingCount').textContent = pending.length;
                document.getElementById('approvedCount').textContent = approved.length;
                document.getElementById('completedCount').textContent = completed.length;

                // Render pending
                document.getElementById('pendingOrders').innerHTML = pending.length > 0
                    ? pending.map(o => renderOrderCard(o, 'pending')).join('')
                    : '<p class="text-gray-500 text-sm">No pending orders</p>';

                // Render approved
                document.getElementById('approvedOrders').innerHTML = approved.length > 0
                    ? approved.map(o => renderOrderCard(o, 'approved')).join('')
                    : '<p class="text-gray-500 text-sm">No orders in progress</p>';

                // Render completed
                document.getElementById('completedOrders').innerHTML = completed.length > 0
                    ? completed.map(o => renderOrderCard(o, 'completed')).join('')
                    : '<p class="text-gray-500 text-sm">No completed orders</p>';

            } catch (err) {
                console.error('Failed to load work orders:', err);
            }
        }

        // Approve order
        async function approveOrder(orderId) {
            const res = await fetch(`/api/work-orders/${orderId}/approve`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) loadAllOrders();
        }

        // Complete order
        async function completeOrder(orderId) {
            const res = await fetch(`/api/work-orders/${orderId}/complete`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` }
            });
            if (res.ok) loadAllOrders();
        }

        // Poll every 5 seconds
        setInterval(loadAllOrders, 5000);
        loadAllOrders();
    </script>
</body>

</html>